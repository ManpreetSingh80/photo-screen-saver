<!--
  ~  Copyright (c) 2015-2017, Michael A. Updike All rights reserved.
  ~  Licensed under the BSD-3-Clause
  ~  https://opensource.org/licenses/BSD-3-Clause
  ~  https://github.com/opus1269/photo-screen-saver/blob/master/LICENSE.md
  -->
<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-styles/typography.html">
<link rel="import" href="../../bower_components/paper-styles/color.html">

<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../../bower_components/iron-label/iron-label.html">
<link rel="import" href="../../bower_components/iron-image/iron-image.html">
<link rel="import" href="../../bower_components/iron-localstorage/iron-localstorage.html">

<link rel="import" href="../../bower_components/paper-material/paper-material.html">
<link rel="import" href="../../bower_components/paper-ripple/paper-ripple.html">
<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../bower_components/paper-dialog-scrollable/paper-dialog-scrollable.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../bower_components/paper-item/paper-item-body.html">
<link rel="import" href="../../bower_components/paper-toolbar/paper-toolbar.html">
<link rel="import" href="../../bower_components/paper-spinner/paper-spinner.html">
<link rel="import" href="../../bower_components/paper-toggle-button/paper-toggle-button.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../../bower_components/paper-tooltip/paper-tooltip.html">

<link rel="import" href="../my_icons.html">

<link rel="import" href="../localize-behavior/localize-behavior.html">

<script type="text/javascript" src="../../scripts/exception_handler.js"></script>

<dom-module id="google-photos-page">
	<template>
		<style include="iron-flex iron-flex-alignment"></style>
		<style include="shared-styles"></style>
		<style>

		:host {
			display: block;
			position: relative;
		}

		::-webkit-scrollbar-thumb {
			background: rgba(63, 81, 181, 1);
		}

		.page-toolbar {
			margin: 0;
		}

		.page-content {
			height: 800px;
			overflow: hidden;
			overflow-y: scroll;
			margin: 0;
		}

		.waiter {
			margin: 40px auto;
		}

		.waiter paper-item {
			@apply(--paper-font-title);
			margin: 40px auto;
		}

		.list-note {
			@apply(--paper-font-title);
			border: 1px #CCCCCC;
			border-bottom-style: solid;
			padding: 8px 16px 8px 16px;
			white-space: normal;
		}

		.list-item {
			position: relative;
			border: 1px #CCCCCC;
			border-bottom-style: solid;
			padding: 0 0 0 5px;
			cursor: pointer;
		}

		.list-item paper-item-body {
			padding-left: 10px;
		}

		.list-item paper-item {
			padding-right: 0;
		}

		.list-item iron-image {
			height: 72px;
			width: 72px;
		}

		.list-item[disabled] iron-image {
			opacity: .2;
		}

		.list-item[disabled] {
			pointer-events: none;
		}

		.list-item[disabled] .setting-label {
			color: var(--disabled-text-color);
		}

		</style>

		<paper-material elevation="1" class="page-container">
			<paper-material elevation="1">
				<paper-toolbar class="page-toolbar">
					<div class="flex">{{localize('google_title')}}</div>
					<paper-icon-button
							id="select"
							icon="myicons:check-box"
							on-tap="_selectAllTapped"
							disabled$="[[!useGoogle]]"></paper-icon-button>
					<paper-tooltip for="select" position="left" offset="0">
						{{localize('tooltip_select')}}
					</paper-tooltip>
					<paper-icon-button
							id="deselect"
							icon="myicons:check-box-outline-blank"
							on-tap="_deselectAllTapped"
							disabled$="[[!useGoogle]]"></paper-icon-button>
					<paper-tooltip for="deselect" position="left" offset="0">
						{{localize('tooltip_deselect')}}
					</paper-tooltip>
					<paper-icon-button
							id="refresh"
							icon="myicons:refresh"
							on-tap="_refreshTapped"
							disabled$="[[!useGoogle]]"></paper-icon-button>
					<paper-tooltip for="refresh" position="left" offset="0">
						{{localize('tooltip_refresh')}}
					</paper-tooltip>
					<paper-toggle-button
							id="googlePhotosToggle"
							checked="{{useGoogle}}"></paper-toggle-button>
					<paper-tooltip for="googlePhotosToggle" position="left" offset="0">
						{{localize('tooltip_google_toggle')}}
					</paper-tooltip>
					<iron-localstorage name="useGoogle" value="{{useGoogle}}"></iron-localstorage>
				</paper-toolbar>
			</paper-material>

			<div class="page-content">

				<!-- Error dialog -->
				<paper-dialog id="errorDialog" modal entry-animation="scale-up-animation"
				              exit-animation="fade-out-animation">
					<h2 id="dialogTitle"></h2>
					<paper-dialog-scrollable>
						<p id="dialogText"></p>
					</paper-dialog-scrollable>
					<div class="buttons">
						<paper-button dialog-dismiss>{{localize('ok')}}</paper-button>
					</div>
				</paper-dialog>

				<div class="waiter" hidden$="[[!waitForLoad]]">
					<div class="horizontal center-justified layout">
						<paper-spinner alt="{{localize('google_loading')}}" active="[[waitForLoad]]"></paper-spinner>
					</div>
					<paper-item class="horizontal center-justified layout">
						{{localize('google_loading')}}
					</paper-item>
				</div>

				<div class="list-container" hidden$="[[waitForLoad]]">
					<paper-item class="list-note" hidden$="[[waitForLoad]]">
						{{localize('google_shared_albums_note')}}
					</paper-item>

					<template is="dom-repeat" id="t" items="{{albums}}" as="album">
						<div class="list-item" id="[[album.uid]]" disabled$="[[!useGoogle]]">
							<iron-label>
								<paper-item class="center horizontal layout" tabindex="-1">
									<paper-checkbox iron-label-target checked="{{album.checked}}" on-change="_albumSelectChange" disabled$="[[!useGoogle]]"></paper-checkbox>
									<paper-item-body class="flex" two-line>
										<div class="setting-label">{{album.name}}</div>
										<div class="setting-label" secondary>{{_computePhotoLabel(album.ct)}}</div>
										<paper-ripple center></paper-ripple>
									</paper-item-body>
									<iron-image src="[[album.thumb]]" sizing="cover" preload disabled$="[[!useGoogle]]"></iron-image>
								</paper-item>
							</iron-label>
						</div>
					</template>
				</div>
			</div>
			<content></content>
		</paper-material>
	</template>
</dom-module>

<script>
'use strict';

new ExceptionHandler();

window.app = window.app || {};
app.GooglePhotosPage = Polymer({
	is: 'google-photos-page',

	behaviors: [
		app.LocalizeBehavior,
	],

	properties: {
		albums: {
			/** @type {app.GooglePhotos.Album[]} */
			type: Array,
			notify: true,
			value: [],
		},

		selections: {
			/** @type {{id: id, photos: photos}} */
			type: Array,
			value: [],
		},

		waitForLoad: {
			type: Boolean,
			value: false,
		},
	},

	// so we can lazily create the page
	factoryImpl: function(id) {
		this.setAttribute('id', id);
	},

	ready: function() {
		this.loadAlbumList();
	},

	/**
	 * Query Picasa for the list of the users albums
	 */
	loadAlbumList: function() {
		this.set('waitForLoad', true);
		// call interactively
		app.GooglePhotos.loadAlbumList(true).then((albums) => {
			// get all the user's albums
			this.splice('albums', 0, this.albums.length);
			albums.forEach((album) => {
				this.push('albums', album);
			});
			// update the currently selected albums from the web
			// eslint-disable-next-line promise/no-nesting
			app.PhotoSource.process('useGoogle').catch(() => {});
			return null;
		}).then(() => {
			// set select state on albums
			this._selectAlbums();
			this.set('waitForLoad', false);
			return null;
		}).catch((err) => {
			this.set('waitForLoad', false);
			app.GA.error(err.message, 'app.GooglePhotosPage.loadAlbumList');
			this.$.dialogTitle.innerHTML =
				app.Utils.localize('err_request_failed');
			this.$.dialogText.innerHTML = err.message;
			this.$.errorDialog.open();
		});
	},

	/**
	 * Event: Handle tap on refresh album list icon
	 * @private
	 */
	_refreshTapped: function() {
		this.loadAlbumList();
	},

	/**
	 * Event: Handle tap on select all albums icon
	 * @private
	 */
	_selectAllTapped: function() {
		for (let i = 0; i < this.albums.length; i++) {
			const album = this.albums[i];
			if (!album.checked) {
				this.selections.push({id: album.id, photos: album.photos});
				const set = app.Storage
					.safeSet('albumSelections', this.selections, null);
				if (!set) {
					// exceeded storage limits
					this.selections.pop();
					break;
				}
				this.set('albums.' + i + '.checked', true);
			}
		}
	},

	/**
	 * Event: Handle tap on deselect all albums icon
	 * @private
	 */
	_deselectAllTapped: function() {
		this._uncheckAll();
		this.selections.splice(0, this.selections.length);
		app.Storage.set('albumSelections', this.selections);
	},

	/**
	 * Event: Handle tap on checkbox for an album
	 * @param {Event} event - tap event
	 * @param {Event} event.model - the model
	 * @param {Event} event.model.album - the album
	 * @private
	 */
	_albumSelectChange: function(event) {
		const album = event.model.album;
		const index = this.selections.map(function(e) {
			return e.id;
		}).indexOf(album.id);

		if (index !== -1) {
			this.selections.splice(index, 1);
		}

		if (album.checked) {
			this.selections.push({id: album.id, photos: album.photos});
		}

		const set =
			app.Storage.safeSet('albumSelections', this.selections, null);
		if (!set) {
			// exceeded storage limits
			this.selections.pop();
			this.set('albums.' + album.index + '.checked', false);
		}
	},

	/**
	 * Set the checked state of the stored albums
	 * @private
	 */
	_selectAlbums: function() {
		this.set('selections', app.Storage.get('albumSelections'));
		for (let i = 0; i < this.albums.length; i++) {
			for (let j = 0; j < this.selections.length; j++) {
				if (this.albums[i].id === this.selections[j].id) {
					this.set('albums.' + i + '.checked', true);
					break;
				}
			}
		}
	},

	/**
	 * Uncheck all albums
	 * @private
	 */
	_uncheckAll: function() {
		this.albums.forEach((album, index) => {
			if (album.checked) {
				this.set('albums.' + index + '.checked', false);
			}
		});
	},

	/**
	 * Computed binding: Set photo count label on an album
	 * @param {int} count - number of photos in album
	 * @returns {string} i18n label
	 * @private
	 */
	_computePhotoLabel: function(count) {
		let ret = `${count} ${app.Utils.localize('photos')}`;
		if (count === 1) {
			ret = `${count} ${app.Utils.localize('photo')}`;
		}
		return ret;
	},
});
</script>
